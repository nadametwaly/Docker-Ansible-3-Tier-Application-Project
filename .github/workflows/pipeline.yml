name: CI/CD workflow
on:
    workflow_dispatch:
        inputs:
            environment:
                description: 'Select deployment environment'
                required: true
                type: choice
                options:
                    - dev
                    - staging
                    - production
permissions:    
    contents: read
    security-events: write
    packages: write
jobs:
    dotnet-ci:
        permissions:
            contents: read
            actions: read
            security-events: write
        uses: nadametwaly/centralized-automation-repo/.github/workflows/dotnet.yml@main
        with:
            dotnet-version: "8.0"
            project-path: "./DotNet-Backend"
            build-configuration: "Release"
            run-tests: true
            dockerfile-path: "./DotNet-Backend/Dockerfile"
        secrets:
            docker_password: ${{ secrets.DOCKER_PASSWORD }}

    react-ci:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
            actions: read
            packages: write 
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v6.1.0
            with:
                node-version: 20
          - name: Installing Dependencies
            run: npm install
            working-directory: React-Frontend

          - name: Build React Application
            run: npm run build
            working-directory: React-Frontend

          - name: CodeQL Analysis
            uses: github/codeql-action/init@v3
            with:
                languages: javascript
          - name: Perform CodeQL Analysis
            uses: github/codeql-action/analyze@v3

          - name: Run Gitleaks for secret detection
            uses: gitleaks/gitleaks-action@v2
            continue-on-error: true
          - name: Upload Gitleaks results to GitHub
            uses: github/codeql-action/upload-sarif@v3
            if: always()
            with:
                sarif_file: results.sarif
                category: gitleaks

          - name: Build & Push React Docker Image to GHCR
            uses: nadametwaly/centralized-automation-repo/.github/actions/react-docker-s2i@main
            with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
                image-name: ${{ github.actor }}/react-frontend
                tag: latest

          - name: Log in to Docker Hub
            uses: docker/login-action@v3
            with:
                username: nadametwaly24
                password: ${{ secrets.DOCKER_PASSWORD }}
          - name: Build & Push React Docker Image to Docker Hub
            uses: nadametwaly/centralized-automation-repo/.github/actions/react-docker-s2i@main
            with:
                registry: docker.io  # or just remove this line if docker.io is default
                username: nadametwaly24
                password: ${{ secrets.DOCKER_PASSWORD }}
                image-name: nadametwaly24/react-frontend
                tag: latest

          - name: Run Trivy     #vulnerability scanner
            uses: aquasecurity/trivy-action@0.33.1
            with:
                image-ref: 'ghcr.io/${{ github.actor }}/react-frontend:${{ github.sha }}'
                format: 'sarif'
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH'
          - name: Upload Trivy scan results to GitHub Security tab
            uses: github/codeql-action/upload-sarif@v4
            with:
                sarif_file: 'trivy-results.sarif'





    
    deploy-react-railway:
        needs: react-ci
        runs-on: ubuntu-latest
        if: ${{ github.event.inputs.environment != 'dev' }}
        environment:
            name: ${{ github.event.inputs.environment }}
        steps:
          - name: Trigger Railway Deployment via API
            run: |
                RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                  https://backboard.railway.app/graphql/v2 \
                  -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  -d '{"query":"mutation serviceInstanceRedeploy($serviceId: String!) { serviceInstanceRedeploy(serviceId: $serviceId) }","variables":{"serviceId":"${{ secrets.RAILWAY_REACT_SERVICE_ID }}"}}')
                
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                BODY=$(echo "$RESPONSE" | head -n-1)
                
                if [ "$HTTP_CODE" -eq 200 ]; then
                    echo "✅ Railway deployment triggered successfully for React app"
                    echo "Response: $BODY"
                    echo "Check Railway dashboard for deployment progress"
                else
                    echo "❌ Failed to trigger deployment. HTTP Code: $HTTP_CODE"
                    echo "Response: $BODY"
                    exit 1
                fi

    deploy-dotnet-railway:
        needs: dotnet-ci
        runs-on: ubuntu-latest
        if: ${{ github.event.inputs.environment != 'dev' }}
        environment:
            name: ${{ github.event.inputs.environment }}
        steps:
          - name: Trigger Railway Deployment via API
            run: |
                RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                  https://backboard.railway.app/graphql/v2 \
                  -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
                  -H "Content-Type: application/json" \
                  -d '{"query":"mutation serviceInstanceRedeploy($serviceId: String!) { serviceInstanceRedeploy(serviceId: $serviceId) }","variables":{"serviceId":"${{ secrets.RAILWAY_DOTNET_SERVICE_ID }}"}}')
                
                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                BODY=$(echo "$RESPONSE" | head -n-1)
                
                if [ "$HTTP_CODE" -eq 200 ]; then
                    echo "✅ Railway deployment triggered successfully for .NET backend"
                    echo "Response: $BODY"
                    echo "Check Railway dashboard for deployment progress"
                else
                    echo "❌ Failed to trigger deployment. HTTP Code: $HTTP_CODE"
                    echo "Response: $BODY"
                    exit 1
                fi


    deploy-dev:
        needs: [dotnet-ci, react-ci]
        if: ${{ github.event.inputs.environment == 'dev' }}
        runs-on: [self-hosted, linux]
        environment:
            name: dev
        steps:
          - uses: actions/checkout@v4

          - name: Deploy full stack with Ansible
            env:
                DB_HOST: ${{ vars.DB_HOST }}
                DB_PORT: ${{ vars.DB_PORT }}
                DB_NAME: ${{ vars.DB_NAME }}
                DB_USER: ${{ vars.DB_USER }}
                DB_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
                API_URL: ${{ vars.API_URL }}
            run: |
                ansible-playbook deploy.yml \
                -e "environment=dev" \
                -e "github_actor=${{ github.actor }}" \
                -e "github_token=${{ secrets.GITHUB_TOKEN }}" \
                -e "docker_username=${{ secrets.DOCKER_USERNAME }}" \
                -e "docker_password=${{ secrets.DOCKER_PASSWORD }}" \
                -e "db_host=${DB_HOST}" \
                -e "db_port=${DB_PORT}" \
                -e "db_name=${DB_NAME}" \
                -e "db_user=${DB_USER}" \
                -e "db_password=${DB_PASSWORD}" \
                -e "api_url=${API_URL}"