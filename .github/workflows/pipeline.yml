name: CI/CD workflow
on:
    workflow_dispatch:
        inputs:
            environment:
                description: 'Select deployment environment'
                required: true
                type: choice
                options:
                    - dev
                    - staging
                    - production
permissions:    
    contents: read
    security-events: write
    packages: write
jobs:
    dotnet-ci:
        permissions:
            contents: read
            actions: read
            security-events: write
        uses: nadametwaly/centralized-automation-repo/.github/workflows/dotnet.yml@main
        with:
            dotnet-version: "8.0"
            project-path: "./DotNet-Backend"
            build-configuration: "Release"
            run-tests: true
            dockerfile-path: "./DotNet-Backend/Dockerfile"
        secrets:
            docker_password: ${{ secrets.DOCKER_PASSWORD }}

    react-ci:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
            actions: read
            packages: write 
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v6.1.0
            with:
                node-version: 20
          - name: Installing Dependencies
            run: npm install
            working-directory: React-Frontend

          - name: Build React Application
            run: npm run build
            working-directory: React-Frontend

          - name: CodeQL Analysis
            uses: github/codeql-action/init@v3
            with:
                languages: javascript
          - name: Perform CodeQL Analysis
            uses: github/codeql-action/analyze@v3

          - name: Run Gitleaks for secret detection
            uses: gitleaks/gitleaks-action@v2
            continue-on-error: true
          - name: Upload Gitleaks results to GitHub
            uses: github/codeql-action/upload-sarif@v3
            if: always()
            with:
                sarif_file: results.sarif
                category: gitleaks

          - name: Build & Push React Docker Image to GHCR
            uses: nadametwaly/centralized-automation-repo/.github/actions/react-docker-s2i@main
            with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
                image-name: ${{ github.actor }}/react-frontend
                tag: latest

          - name: Log in to Docker Hub
            uses: docker/login-action@v3
            with:
                username: nadametwaly24
                password: ${{ secrets.DOCKER_PASSWORD }}
          - name: Build & Push React Docker Image to Docker Hub
            uses: nadametwaly/centralized-automation-repo/.github/actions/react-docker-s2i@main
            with:
                registry: docker.io  # or just remove this line if docker.io is default
                username: nadametwaly24
                password: ${{ secrets.DOCKER_PASSWORD }}
                image-name: nadametwaly24/react-frontend
                tag: latest

          - name: Run Trivy     #vulnerability scanner
            uses: aquasecurity/trivy-action@0.33.1
            with:
                image-ref: 'ghcr.io/${{ github.actor }}/react-frontend:${{ github.sha }}'
                format: 'sarif'
                output: 'trivy-results.sarif'
                severity: 'CRITICAL,HIGH'
          - name: Upload Trivy scan results to GitHub Security tab
            uses: github/codeql-action/upload-sarif@v4
            with:
                sarif_file: 'trivy-results.sarif'








    
    deploy-react-railway:
        name: Deploy React to Railway
        runs-on: ubuntu-latest
        needs: react-ci
        if: github.event.inputs.environment != 'dev'
        environment: ${{ github.event.inputs.environment }}
        
        steps:
          - name: Checkout Repository
            uses: actions/checkout@v4
        
          - name: Install Railway CLI
            run: |
                npm install -g @railway/cli
        
          - name: Set Railway Variables
            env:
                RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
                RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
            run: |
                railway variables set \
                DB_HOST=${{ vars.DB_HOST }} \
                DB_PORT=${{ vars.DB_PORT }} \
                DB_NAME=${{ vars.DB_NAME }} \
                DB_USER=${{ vars.DB_USER }} \
                MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }} \
                --service ${{ secrets.RAILWAY_REACT_SERVICE_ID }} \
                --environment ${{ vars.RAILWAY_ENVIRONMENT_ID }}

          - name: Deploy React
            env:
                RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
                RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
            run: |
                railway up \
                --service ${{ secrets.RAILWAY_REACT_SERVICE_ID }} \
                --environment ${{ vars.RAILWAY_ENVIRONMENT_ID }} \
                --detach

          - name: Deployment Summary
            run: |
                echo "## ðŸš€ React Deployment Complete" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
                echo "**Service URL:** ${{ vars.RAILWAY_REACT_URL }}" >> $GITHUB_STEP_SUMMARY
                echo "**Service ID:** ${{ secrets.RAILWAY_REACT_SERVICE_ID }}" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âœ… React application deployed successfully!" >> $GITHUB_STEP_SUMMARY

    # ========================================
    # ðŸ”µ Deploy .NET to Railway (Staging & Production)
    # ========================================
    deploy-dotnet-railway:
        name: Deploy .NET to Railway
        runs-on: ubuntu-latest
        needs: dotnet-ci
        if: github.event.inputs.environment != 'dev'
        environment: ${{ github.event.inputs.environment }}
        
        steps:
          - name: Checkout Repository
            uses: actions/checkout@v4
        
          - name: Install Railway CLI
            run: |
                npm install -g @railway/cli
        
          - name: Set Environment Variables
            env:
                RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
            run: |
                railway variables set \
                    DB_HOST=${{ vars.DB_HOST }} \
                    DB_PORT=${{ vars.DB_PORT }} \
                    DB_NAME=${{ vars.DB_NAME }} \
                    DB_USER=${{ vars.DB_USER }} \
                    MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }} \
                    --service ${{ secrets.RAILWAY_DOTNET_SERVICE_ID }} \
                    --environment ${{ github.event.inputs.environment }}
            
          - name: Deploy .NET Service to Railway
            env:
                RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
            run: |
                railway up --service ${{ secrets.RAILWAY_DOTNET_SERVICE_ID }} \
                    --environment ${{ github.event.inputs.environment }} \
                    --detach
        
          - name: Deployment Summary
            run: |
                echo "## ðŸš€ .NET Deployment Complete" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
                echo "**Service URL:** ${{ vars.RAILWAY_DOTNET_URL }}" >> $GITHUB_STEP_SUMMARY
                echo "**Service ID:** ${{ secrets.RAILWAY_DOTNET_SERVICE_ID }}" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âœ… .NET backend deployed successfully!" >> $GITHUB_STEP_SUMMARY



    deploy-dev:
        needs: [dotnet-ci, react-ci]
        if: ${{ github.event.inputs.environment == 'dev' }}
        runs-on: [self-hosted, linux]
        environment:
            name: dev
        steps:
        # Step 1: Checkout code
          - name: Checkout repository
            uses: actions/checkout@v4
        
        
          - name: Install Ansible and Docker collection
            run: |
                python -m pip install --upgrade pip
                pip install ansible
                ansible-galaxy collection install community.docker
                ansible --version
        
        # Step 3: Verify Ansible playbook syntax
          - name: Verify Ansible playbook syntax
            run: |
                ansible-playbook playbook.yml --syntax-check
        
        # Step 4: Create vars directory and files
          - name: Create Ansible vars files
            run: |
                mkdir -p vars
            
                # Create main.yml with Docker username
                cat > vars/main.yml << 'EOF'
                DOCKER_USERNAME: "nadametwaly24"
                EOF
                
                # Create secrets.yml with sensitive variables
                cat > vars/secrets.yml << 'EOF'
                DOCKER_PASSWORD: "${{ secrets.DOCKER_PASSWORD }}"
                DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"
                EOF
                
                # Secure the secrets file
                chmod 600 vars/secrets.yml
        
        # Step 5: Run Ansible playbook for deployment
          - name: Run Ansible playbook
            env:
                ANSIBLE_HOST_KEY_CHECKING: 'False'
                ANSIBLE_FORCE_COLOR: 'True'
            run: |
                ansible-playbook playbook.yml \
                    -e "DOCKER_USERNAME=nadametwaly24" \
                    -e "DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}" \
                    -e "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
                    -v
        
      
          - name: Display deployment status
            if: always()
            run: |
                echo "ðŸ“Š Deployment Status Report"
                echo "=============================="
                echo ""
                echo "ðŸ³ Running Containers:"
                docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                echo ""
                echo "ðŸ“¦ Docker Images:"
                docker images | grep -E "nadametwaly24|REPOSITORY"
                echo ""
                echo "ðŸ”— Docker Compose Services:"
                docker-compose ps || echo "Unable to get compose status"
        
        # Step 9: Cleanup sensitive files
          - name: Cleanup sensitive files
            if: always()
            run: |
                echo "ðŸ§¹ Cleaning up sensitive files..."
                rm -f vars/secrets.yml
                rm -f db_password.txt
                echo "âœ… Cleanup completed"
        
        # Step 10: Deployment summary
          - name: Deployment summary
            if: always()
            run: |
                echo "## ðŸš€ Dev Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                echo "| Environment | \`dev\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Runner | Self-hosted Linux |" >> $GITHUB_STEP_SUMMARY
                echo "| Status | **${{ job.status }}** |" >> $GITHUB_STEP_SUMMARY
                echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Author | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
                echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                echo "| Workflow | ${{ github.workflow }} |" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                
                if [ "${{ job.status }}" == "success" ]; then
                    echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Deployed Services:**" >> $GITHUB_STEP_SUMMARY
                    echo "- ðŸ”™ Backend API (DotNet)" >> $GITHUB_STEP_SUMMARY
                    echo "- ðŸŽ¨ Frontend (React)" >> $GITHUB_STEP_SUMMARY
                    echo "- ðŸ—„ï¸  Database (PostgreSQL)" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
                    echo "- \`nadametwaly24/backend-dotnet-api:latest\`" >> $GITHUB_STEP_SUMMARY
                    echo "- \`nadametwaly24/frontend-react:latest\`" >> $GITHUB_STEP_SUMMARY
                else
                    echo "### âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
                fi
            
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "---" >> $GITHUB_STEP_SUMMARY
                echo "ðŸ“ **Note:** This is a local deployment using Ansible and Docker Compose" >> $GITHUB_STEP_SUMMARY
            
    